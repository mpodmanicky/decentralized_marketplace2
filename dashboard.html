<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Royalty Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1, h2 { color: #333; }
    .card { background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f2f2f2; }
    tr:hover { background-color: #f5f5f5; }
    .tabs { display: flex; margin-bottom: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px 4px 0 0; margin-right: 5px; }
    .tab.active { background-color: #f0f0f0; border-bottom: none; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Royalty Dashboard</h1>

  <div class="tabs">
    <div class="tab active" data-tab="sales">Sales</div>
    <div class="tab" data-tab="publications">Publications</div>
    <div class="tab" data-tab="royalties">Royalties</div>
    <div class="tab" data-tab="parameters">Parameters</div>
  </div>

  <div id="sales" class="tab-content active">
    <h2>Recent Sales</h2>
    <div class="card">
      <table id="sales-table">
        <thead>
          <tr>
            <th>Repository</th>
            <th>Software ID</th>
            <th>Price (ETH)</th>
            <th>Timestamp</th>
            <th>Buyer</th>
            <th>Developer</th>
            <th>Royalty (ETH)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="publications" class="tab-content">
    <h2>Software Publications</h2>
    <div class="card">
      <table id="publications-table">
        <thead>
          <tr>
            <th>Repository</th>
            <th>Software ID</th>
            <th>Publish Time</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="3">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="royalties" class="tab-content">
    <h2>Developer Royalties</h2>
    <div class="card">
      <label for="developer-address">Developer Address:</label>
      <input type="text" id="developer-address" placeholder="0x..." style="width: 350px; padding: 5px;">
      <button id="check-royalties" style="padding: 5px 10px;">Check Royalties</button>

      <div id="royalty-result" style="margin-top: 20px;">
        <p>Enter a developer address to check their royalties.</p>
      </div>
    </div>
  </div>

  <div id="parameters" class="tab-content">
    <h2>Royalty Parameters</h2>
    <div class="card">
      <div id="parameters-content">
        <p>Loading...</p>
      </div>
      <div id="decay-chart" style="height: 300px; margin-top: 20px;">
        <!-- Decay visualization will go here -->
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Format timestamp
    function formatTimestamp(timestamp) {
      return new Date(timestamp * 1000).toLocaleString();
    }

    // Format address
    function formatAddress(address) {
      return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
    }

    // Format ETH
    function formatEth(wei) {
      return (parseInt(wei) / 1e18).toFixed(6);
    }

    // Load sales data
    async function loadSales() {
      try {
        const response = await fetch('/api/sales');
        const sales = await response.json();

        const tableBody = document.querySelector('#sales-table tbody');
        tableBody.innerHTML = '';

        if (sales.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="7">No sales recorded yet</td></tr>';
          return;
        }

        sales.forEach(sale => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td title="${sale.repository}">${formatAddress(sale.repository)}</td>
            <td>${sale.software_id}</td>
            <td>${formatEth(sale.price)}</td>
            <td>${formatTimestamp(sale.timestamp)}</td>
            <td title="${sale.buyer}">${formatAddress(sale.buyer)}</td>
            <td title="${sale.developer}">${formatAddress(sale.developer)}</td>
            <td>${sale.royalty_amount ? formatEth(sale.royalty_amount) : 'Calculating...'}</td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading sales:', error);
      }
    }

    // Load publications data
    async function loadPublications() {
      try {
        const response = await fetch('/api/publications');
        const publications = await response.json();

        const tableBody = document.querySelector('#publications-table tbody');
        tableBody.innerHTML = '';

        if (publications.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="3">No publications recorded yet</td></tr>';
          return;
        }

        publications.forEach(pub => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td title="${pub.repository}">${formatAddress(pub.repository)}</td>
            <td>${pub.software_id}</td>
            <td>${formatTimestamp(pub.publish_time)}</td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading publications:', error);
      }
    }

    // Load parameters
    async function loadParameters() {
      try {
        const response = await fetch('/api/parameters');
        const params = await response.json();

        // Normalize parameter names
        const initialRate = params.initial_rate || params.initialRate || 10;
        const decayFactor = params.decay_factor || params.decayFactor || 65;
        const decayPeriod = params.decay_period || params.decayPeriod || 30 * 24 * 60 * 60;

        document.getElementById('parameters-content').innerHTML = `
          <h3>Current Parameters</h3>
          <p><strong>Initial Rate:</strong> ${initialRate}%</p>
          <p><strong>Decay Factor:</strong> ${decayFactor}% (${100-decayFactor}% reduction per level)</p>
          <p><strong>Maximum Depth:</strong> 5 levels in dependency tree</p>

          <h3>Exponential Decay Model</h3>
          <p>Royalty Rate = Initial Rate Ã— (Decay Factor/100)<sup>depth</sup></p>
          <p>Example calculations:</p>
          <ul>
            <li>Direct author (depth 0): ${initialRate}% of sale price</li>
            <li>Level 1 dependency: ${(initialRate * decayFactor / 100).toFixed(2)}% of sale price</li>
            <li>Level 2 dependency: ${(initialRate * Math.pow(decayFactor/100, 2)).toFixed(2)}% of sale price</li>
            <li>Level 3 dependency: ${(initialRate * Math.pow(decayFactor/100, 3)).toFixed(2)}% of sale price</li>
            <li>Level 4 dependency: ${(initialRate * Math.pow(decayFactor/100, 4)).toFixed(2)}% of sale price</li>
            <li>Level 5 dependency: ${(initialRate * Math.pow(decayFactor/100, 5)).toFixed(2)}% of sale price</li>
          </ul>
        `;

        // Create decay visualization
        renderDecayChart(initialRate, decayFactor);
      } catch (error) {
        console.error('Error loading parameters:', error);
      }
    }

    document.getElementById('check-royalties').addEventListener('click', async () => {
      const developerAddress = document.getElementById('developer-address').value.trim();

      if (!developerAddress) {
        alert('Please enter a developer address');
        return;
      }

      try {
        // First try the enhanced dependency royalty endpoint
        const response = await fetch(`/api/royalties/dependency/${developerAddress}`);
        const data = await response.json();

        let html = `
          <h3>Pending Royalties</h3>
          <p>${formatEth(data.pending)} ETH</p>

          <h3>Royalty Breakdown by Dependency Level</h3>
        `;

        if (data.royalties && data.royalties.length > 0) {
          // Group royalties by sale
          const salesMap = {};
          data.royalties.forEach(r => {
            if (!salesMap[r.sale_id]) {
              salesMap[r.sale_id] = {
                saleId: r.sale_id,
                saleTime: r.sale_time,
                salePrice: r.sale_price,
                royalties: []
              };
            }
            salesMap[r.sale_id].royalties.push(r);
          });

          // Convert to array and sort by time
          const sales = Object.values(salesMap).sort((a, b) => b.saleTime - a.saleTime);

          for (const sale of sales) {
            html += `
              <div class="card" style="margin-top: 15px; background: #f7f7f7;">
                <h4>Sale at ${formatTimestamp(sale.saleTime)}</h4>
                <p>Sale Price: ${formatEth(sale.salePrice)} ETH</p>
                <table>
                  <thead>
                    <tr>
                      <th>Software</th>
                      <th>Depth</th>
                      <th>Rate</th>
                      <th>Amount (ETH)</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            // Sort royalties by depth
            sale.royalties.sort((a, b) => a.depth - b.depth);

            for (const royalty of sale.royalties) {
              html += `
                <tr>
                  <td>${formatAddress(royalty.repository)}-${royalty.software_id}</td>
                  <td>${royalty.depth} ${royalty.depth === 0 ? '(primary author)' : ''}</td>
                  <td>${royalty.rate.toFixed(2)}%</td>
                  <td>${formatEth(royalty.amount)}</td>
                </tr>
              `;
            }

            html += `
                  </tbody>
                </table>
              </div>
            `;
          }

          // Add decay curve visualization if we have the data
          if (data.decayCurve) {
            html += `
              <h3>Current Royalty Decay Model</h3>
              <p>The following chart shows how royalty rates decrease with dependency depth:</p>
              <div style="height: 250px; margin-top: 15px;">
                <canvas id="royalty-decay-chart"></canvas>
              </div>
            `;

            setTimeout(() => {
              const ctx = document.getElementById('royalty-decay-chart');
              new Chart(ctx, {
                type: 'line',
                data: {
                  labels: data.decayCurve.map(d => `Depth ${d.depth}`),
                  datasets: [{
                    label: 'Royalty Rate (%)',
                    data: data.decayCurve.map(d => d.rate),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                  }]
                },
                options: {
                  responsive: true,
                  scales: {
                    y: {
                      beginAtZero: true,
                      title: {
                        display: true,
                        text: 'Rate (%)'
                      }
                    }
                  }
                }
              });
            }, 100);
          }
        } else {
          html += '<p>No royalty data found for this developer</p>';
        }

        document.getElementById('royalty-result').innerHTML = html;
      } catch (error) {
        console.error('Error checking royalties:', error);
        document.getElementById('royalty-result').innerHTML = '<p>Error checking royalties. Please try again.</p>';
      }
    });

    function renderDecayChart(initialRate, decayFactor) {
      const ctx = document.getElementById('decay-chart');

      // Calculate rates for each depth level
      const depths = [0, 1, 2, 3, 4, 5];
      const rates = depths.map(depth => {
        return initialRate * Math.pow(decayFactor/100, depth);
      });

      // If there's an existing chart, destroy it
      if (window.decayChart) {
        window.decayChart.destroy();
      }

      // Create new chart
      window.decayChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: depths.map(d => `Depth ${d}`),
          datasets: [{
            label: 'Royalty Rate (%)',
            data: rates,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Royalty Percentage'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Dependency Depth'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Exponential Decay of Royalty Rates by Dependency Depth'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Royalty: ${context.parsed.y.toFixed(2)}%`;
                }
              }
            }
          }
        }
      });
    }

    // Initial loads
    loadSales();
    loadPublications();
    loadParameters();

    // Refresh data every 30 seconds
    setInterval(() => {
      loadSales();
      loadPublications();
      loadParameters();
    }, 30000);
  </script>
</body>
</html>
