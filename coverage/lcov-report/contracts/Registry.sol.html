<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/Registry.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Registry.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">68.97% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>20/29</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">41.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>5/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">73.33% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">73.68% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>28/38</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: SEE LICENSE IN LICENSE
pragma solidity ^0.8.4;
&nbsp;
import "./Repository.sol";
import "./LicenseManager.sol";
import "./RoyaltyManager.sol";
&nbsp;
/// @title Registry
/// @notice This contract manages the registration of developers and their software, allows minting and manages references between software
contract Registry {
    address private immutable owner;
    uint256 private repositoryCounter;
    address private immutable licenseManager;
    address private marketplace;
    address private immutable royaltyManager;
&nbsp;
    // array of developer contracts
    mapping(address =&gt; bool) private repositories; // saving gas
    // stores wallet Address asociated with developer contract
    mapping(address =&gt; address) private walletToRepository;
&nbsp;
    // stores developer contract address asociated with software tokenIds
    // mapping(address =&gt; uint256[]) private repositoryToTokenIds;
    // For optimal gas usage, we will query the repository contract for the token IDs
&nbsp;
    // Event to emit when minted a software
    event SoftwareMinted(address indexed developer, uint256 indexed softwareId, string tokenURI);
    event RepositoryCreated(address indexed developer, address indexed repository);
    event LicenseMinted(address indexed buyer, address indexed repository, uint256 indexed softwareId, uint256 licenseId);
    //custom Errors
    error NotContractOwner();
    error NotMarketplace();
    error AlreadyRegistered();
    error NotRegisteredDeveloper();
    error NotRegisteredRepository();
    error DeveloperHasNoRepository();
&nbsp;
    constructor() {
        owner = msg.sender;
        repositoryCounter = 0;
        licenseManager = address(new LicenseManager(address(this)));
        royaltyManager = address(new RoyaltyManager(address(this)));
    }
&nbsp;
    function setMarketplace(address _marketplace) external {
        <span class="missing-if-branch" title="if path not taken" >I</span>if(msg.sender != owner) revert NotContractOwner();
        marketplace = _marketplace;
    }
&nbsp;
    /// @notice Register a new developer/repo contract
    /// @dev This function allows a developer to register their contract/create repo, finally the registry is owner of all other contracts
    // @todo emit eventu ze sa vytvorilo repo done
    function createRepository() public returns (address) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (walletToRepository[msg.sender] != address(0)) revert AlreadyRegistered();
&nbsp;
        address newRepository = _createRepositoryContract(msg.sender);
        repositories[newRepository] = true;
        walletToRepository[msg.sender] = newRepository;
        repositoryCounter++;
&nbsp;
        emit RepositoryCreated(msg.sender, newRepository);
        return newRepository;
    }
&nbsp;
    function _createRepositoryContract(address developer) internal returns (address) {
        return address(new Repository(address(this), developer));
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getOrCreateRepository() private returns (address) {</span>
<span class="cstat-no" title="statement not covered" >        address repoAddress = walletToRepository[msg.sender];</span>
&nbsp;
        //if the developer doesn't have a repository, create one
<span class="cstat-no" title="statement not covered" >        if (repoAddress == address(0)) {</span>
            repoAddress = createRepository();
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        return repoAddress;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function mintSoftware(string memory _tokenURI, address[] memory addresses, uint256[][] memory _tokenIds)</span>
        external
        returns (uint256)
    {
<span class="cstat-no" title="statement not covered" >        address repository = getOrCreateRepository();</span>
        //external call
<span class="cstat-no" title="statement not covered" >        uint256 tokenId = Repository(repository).mintSoftware( _tokenURI, addresses, _tokenIds);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit SoftwareMinted(msg.sender, tokenId, _tokenURI);</span>
<span class="cstat-no" title="statement not covered" >        return tokenId;</span>
    }
&nbsp;
    /// @notice Mint a license for a software
    /// @param buyer The address that will own the license
    /// @param developer The developer who listed the software
    /// @param softwareId The ID of the software being licensed
    /// @return licenseId The ID of the newly minted license
    function mintLicense(address buyer, address developer, uint256 softwareId)
        external
        returns (uint256)
    {
        <span class="missing-if-branch" title="if path not taken" >I</span>if(msg.sender != marketplace) revert NotMarketplace();
&nbsp;
        address repositoryAddress = walletToRepository[developer];
        <span class="missing-if-branch" title="if path not taken" >I</span>if(repositoryAddress == address(0)) revert DeveloperHasNoRepository();
&nbsp;
        uint256 licenseId = LicenseManager(licenseManager).mintLicense(buyer, repositoryAddress, softwareId);
&nbsp;
        emit LicenseMinted(buyer, repositoryAddress, softwareId, licenseId);
        return licenseId;
    }
&nbsp;
    function getLicenseManager() external view returns (address) {
        return licenseManager;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function isRepository(address _repositoryAddress) public view returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        return repositories[_repositoryAddress];</span>
    }
&nbsp;
    function isDeveloper(address _sender) external view returns (bool) {
        return walletToRepository[_sender] != address(0);
    }
&nbsp;
    function getRepositoryContract(address _sender) external view returns (address) {
        return walletToRepository[_sender];
    }
&nbsp;
    /// @notice Check if the repository owns the software
    function repositoryOwnsSoftware(address _repository, uint256 _tokenId) external view returns (bool) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if(!repositories[_repository]) revert NotRegisteredRepository();
&nbsp;
        Repository repository = Repository(_repository);
&nbsp;
        return repository.ownerOf(_tokenId) == repository.getDeveloper();
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function hasLicense(address user, address repository, uint256 softwareId) external view returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        return LicenseManager(licenseManager).hasLicense(user, repository, softwareId);</span>
    }
&nbsp;
    function getMarketplace() external view returns (address) {
        return marketplace;
    }
&nbsp;
    function getRoyaltyManager() external view returns (address) {
        return royaltyManager;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu May 08 2025 19:27:35 GMT+0200 (stredoeurópsky letný čas)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
